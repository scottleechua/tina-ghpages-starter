name: Auto-Approve Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  check_suite:
    types: [completed]
  status: {}

permissions:
  pull-requests: write
  checks: read
  actions: read

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: |
      (github.event.pull_request.user.login == 'dependabot[bot]' || 
       github.event.pull_request.user.login == 'dependabot-preview[bot]') ||
      github.event_name == 'check_suite' ||
      github.event_name == 'status'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Get PR number and verify Dependabot
        id: pr_number
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            let pr;
            
            if (context.payload.pull_request?.number) {
              prNumber = context.payload.pull_request.number;
            } else {
              // For check_suite and status events, find PR by commit SHA
              const sha = context.payload.check_suite?.head_sha || 
                          context.payload.commit?.sha || 
                          context.sha;
              
              if (sha) {
                const { data: prsByCommit } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: sha
                });
                
                const openPR = prsByCommit.find(pr => pr.state === 'open');
                if (openPR) {
                  prNumber = openPR.number;
                }
              }
            }
            
            if (!prNumber) {
              core.info('Could not find PR number, skipping...');
              core.setOutput('is_dependabot', 'false');
              return;
            }
            
            // Get PR details to verify it's from Dependabot
            pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const isDependabot = pr.data.user.login === 'dependabot[bot]' || 
                                 pr.data.user.login === 'dependabot-preview[bot]';
            
            if (!isDependabot) {
              core.info(`PR #${prNumber} is not from Dependabot, skipping...`);
              core.setOutput('is_dependabot', 'false');
              return;
            }
            
            core.setOutput('is_dependabot', 'true');
            core.setOutput('number', prNumber.toString());

      - name: Wait for merge button to be available
        if: steps.pr_number.outputs.is_dependabot == 'true'
        uses: actions/github-script@v7
        id: verify
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr_number.outputs.number }}');
            const maxWait = 300; // 5 minutes max wait
            const checkInterval = 10; // Check every 10 seconds
            let waited = 0;
            
            // Wait for the merge button to be available (mergeable_state === 'clean')
            while (waited < maxWait) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              // Check if merge button is available
              // mergeable_state: 'clean' = ready to merge (all checks passed, no conflicts)
              // mergeable_state: 'dirty' = has conflicts
              // mergeable_state: 'unstable' = checks are still running or failed
              // mergeable_state: 'blocked' = blocked by branch protection
              // mergeable_state: null = GitHub is still computing mergeability
              
              if (pr.mergeable === true && pr.mergeable_state === 'clean') {
                core.info('Merge button is available - PR is ready to merge!');
                core.setOutput('can_approve', 'true');
                return;
              }
              
              // If PR has conflicts or is blocked, don't wait
              if (pr.mergeable === false || pr.mergeable_state === 'dirty' || pr.mergeable_state === 'blocked') {
                core.info(`PR cannot be merged: mergeable=${pr.mergeable}, state=${pr.mergeable_state || 'null'}`);
                core.setOutput('can_approve', 'false');
                return;
              }
              
              // If mergeable_state is 'unstable' and mergeable is false, checks likely failed
              if (pr.mergeable_state === 'unstable' && pr.mergeable === false) {
                core.info('Checks failed - PR is not mergeable');
                core.setOutput('can_approve', 'false');
                return;
              }
              
              // Still waiting for checks to complete
              // mergeable_state might be null (computing) or 'unstable' (checks running)
              const stateDisplay = pr.mergeable_state || 'computing';
              core.info(`Waiting for merge button to become available... (state: ${stateDisplay}, mergeable: ${pr.mergeable}, waited ${waited}s)`);
              await new Promise(resolve => setTimeout(resolve, checkInterval * 1000));
              waited += checkInterval;
            }
            
            core.info('Timeout waiting for merge button to become available');
            core.setOutput('can_approve', 'false');

      - name: Approve PR
        if: steps.verify.outputs.can_approve == 'true'
        run: |
          gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url || format('https://github.com/{0}/pull/{1}', github.repository, steps.pr_number.outputs.number) }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
