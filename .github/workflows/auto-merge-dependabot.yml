name: Auto-Approve Dependabot PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write
  checks: read

jobs:
  dependabot:
    runs-on: ubuntu-latest
    # Only run for Dependabot PRs
    if: github.event.pull_request.user.login == 'dependabot[bot]' || github.event.pull_request.user.login == 'dependabot-preview[bot]'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      
      - name: Get PR number
        id: pr_number
        run: |
          echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Wait for merge button to be available
        uses: actions/github-script@v7
        id: verify
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const maxWait = 300; // 5 minutes max wait
            const checkInterval = 10; // Check every 10 seconds
            let waited = 0;
            
            // Wait for the merge button to be available (mergeable_state === 'clean')
            while (waited < maxWait) {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              // Check if merge button is available
              // mergeable_state: 'clean' = ready to merge (all checks passed, no conflicts)
              // mergeable_state: 'dirty' = has conflicts
              // mergeable_state: 'unstable' = checks are still running or some non-required checks failed
              //   - If mergeable=true: PR can be merged (required checks passed, optional may be pending/failed)
              //   - If mergeable=false: checks likely failed
              // mergeable_state: 'blocked' = blocked by branch protection
              // mergeable_state: null = GitHub is still computing mergeability
              
              // Approve only if mergeable and state is 'clean' (all checks passed)
              if (pr.mergeable === true && pr.mergeable_state === 'clean') {
                core.info('Merge button is available - PR is ready to merge! (all checks passed)');
                core.setOutput('can_approve', 'true');
                return;
              }
              
              // If PR has conflicts or is blocked, don't wait
              if (pr.mergeable === false || pr.mergeable_state === 'dirty' || pr.mergeable_state === 'blocked') {
                core.info(`PR cannot be merged: mergeable=${pr.mergeable}, state=${pr.mergeable_state || 'null'}`);
                core.setOutput('can_approve', 'false');
                return;
              }
              
              // If mergeable_state is 'unstable' and mergeable is false, checks likely failed
              if (pr.mergeable_state === 'unstable' && pr.mergeable === false) {
                core.info('Checks failed - PR is not mergeable');
                core.setOutput('can_approve', 'false');
                return;
              }
              
              // Still waiting for checks to complete
              // mergeable_state might be null (computing) or 'unstable' (checks running)
              const stateDisplay = pr.mergeable_state || 'computing';
              core.info(`Waiting for merge button to become available... (state: ${stateDisplay}, mergeable: ${pr.mergeable}, waited ${waited}s)`);
              await new Promise(resolve => setTimeout(resolve, checkInterval * 1000));
              waited += checkInterval;
            }
            
            core.info('Timeout waiting for merge button to become available');
            core.setOutput('can_approve', 'false');

      - name: Approve PR
        if: steps.verify.outputs.can_approve == 'true'
        run: |
          gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge PR
        if: steps.verify.outputs.can_approve == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              
              core.info(`Successfully merged Dependabot PR #${prNumber}`);
            } catch (error) {
              core.error(`Failed to merge PR #${prNumber}: ${error.message}`);
              throw error;
            }
